version: 0.2

phases:
  pre_build:
    commands:
      - |
          PIPELINE_PHASE="${PIPELINE_PHASE:-build}"
          echo "Pipeline phase: $PIPELINE_PHASE"
          if [ "$PIPELINE_PHASE" = "build" ]; then
            echo "Logging in to Amazon ECR..."
            aws ecr get-login-password --region "$AWS_DEFAULT_REGION" | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com"
            export REPOSITORY_URI="$ECR_REPOSITORY"
            export COMMIT_HASH="$(echo "$CODEBUILD_RESOLVED_SOURCE_VERSION" | cut -c 1-7)"
            export IMAGE_TAG="${COMMIT_HASH}-${CODEBUILD_BUILD_NUMBER}"
            echo "Image tag: $IMAGE_TAG"
          else
            echo "Health check phase - skipping ECR login."
          fi

  build:
    commands:
      - |
          PIPELINE_PHASE="${PIPELINE_PHASE:-build}"
          if [ "$PIPELINE_PHASE" = "build" ]; then
            echo "Build started on $(date)"
            echo "Building API Docker image..."
            cd "$CODEBUILD_SRC_DIR/packages/api"
            docker build -t "$REPOSITORY_URI:$IMAGE_TAG" .
            docker tag "$REPOSITORY_URI:$IMAGE_TAG" "$REPOSITORY_URI:latest"
          else
            echo "Running API health check against ${API_URL}/health ..."
            if [ -z "${API_URL:-}" ]; then
              echo "API_URL environment variable is not set."
              exit 1
            fi
            STATUS_CODE="$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health" || echo "000")"
            if [ "$STATUS_CODE" = "200" ]; then
              echo "Health check passed with status 200."
            else
              echo "Health check failed with status ${STATUS_CODE}."
              exit 1
            fi
          fi

  post_build:
    commands:
      - |
          PIPELINE_PHASE="${PIPELINE_PHASE:-build}"
          cd "$CODEBUILD_SRC_DIR"
          if [ "$PIPELINE_PHASE" = "build" ]; then
            echo "Build completed on $(date)"
            echo "Pushing Docker image..."
            docker push "$REPOSITORY_URI:$IMAGE_TAG"
            docker push "$REPOSITORY_URI:latest"
            echo "Writing lambda image descriptor..."
            echo "{\"imageUri\": \"${REPOSITORY_URI}:${IMAGE_TAG}\"}" > lambda-image.json
            cat lambda-image.json
          else
            echo "Health check completed on $(date)"
            echo "{\"status\": \"ok\", \"checkedAt\": \"$(date +%Y-%m-%dT%H:%M:%SZ)\"}" > lambda-image.json
            cat lambda-image.json
          fi

artifacts:
  files:
    - lambda-image.json

